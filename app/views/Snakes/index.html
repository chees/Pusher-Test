#{extends 'main.html' /}
#{set title:'Snakes on a Plane' /}
#{set 'moreStyles'}
	#{stylesheet 'controller.css' /}
#{/set}

<div class="directions">
	<span id="left">⇦</span>
	<span id="right">⇨</span>
</div>

<script src="http://js.pusher.com/1.11/pusher.min.js"></script>
<script>
//Enable pusher logging - don't include this in production
Pusher.log = function(message) {
	if (window.console && window.console.log) window.console.log(message);
};

// Flash fallback logging - don't include this in production
WEB_SOCKET_DEBUG = true;

var id = '';
var subscription_succeeded = false;
var dir = 0; // Direction -1:left, 0:straight, 1:right

var pusher = new Pusher('f4bc874a627d26b1eb2b');
var channel = pusher.subscribe('presence-channel');
channel.bind('pusher:subscription_succeeded', function(d) {
	id = readCookie('id');
	subscription_succeeded = true;
});
channel.bind('client-event', function(data) {
	console.log('' + Date.now() + ' ' + data);
});


function handleEvent(e) {
	e.preventDefault();
	if (!subscription_succeeded) return;
	
	if (e.srcElement.id == 'left') {
		channel.trigger('client-event', { 'id': id, 'dir': 1 });
	}
	if (e.srcElement.id == 'right') {
		channel.trigger('client-event', { 'id': id, 'dir': -1 });
	}
}

function handleKeyDown(e) {
	if (e.keyCode == 37) {
		if (dir != 1) {
			dir = 1;
			channel.trigger('client-event', { 'id': id, 'dir': dir });
		}
	}
	if (e.keyCode == 39) {
		if (dir != -1) {
			dir = -1;
			channel.trigger('client-event', { 'id': id, 'dir': dir });
		}
	}
}

function handleKeyUp(e) {
	if (e.keyCode == 37 && dir == 1 || e.keyCode == 39 && dir == -1) {
		dir = 0;
		channel.trigger('client-event', { 'id': id, 'dir': dir });
	}
}

function init() {
	var left = document.getElementById('left');
	var right = document.getElementById('right');
	
	if (typeof(document.ontouchmove) != 'undefined') {
		left.addEventListener('touchstart', handleEvent, false);
		left.addEventListener('touchmove', handleEvent, false);
		right.addEventListener('touchstart', handleEvent, false);
		right.addEventListener('touchmove', handleEvent, false);
	} else {
		left.addEventListener('mousedown', handleEvent, false);
		right.addEventListener('mousedown', handleEvent, false);
	}
	
	document.addEventListener('keydown', handleKeyDown, false);
	document.addEventListener('keyup', handleKeyUp, false);
}

init();



function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

</script>
